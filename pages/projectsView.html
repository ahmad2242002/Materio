<!DOCTYPE html>
<!-- Designined by CodingLab | www.youtube.com/codinglabyt -->
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <!--<title> Responsiive Admin Dashboard | CodingLab </title>-->
    <link rel="stylesheet" href="../css/dashboard.css">
    <link rel="stylesheet" href="../css/adminlte.min.css">
    <!-- Boxicons CDN Link -->
    <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css"
        integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project View</title>
    <style>
        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <div class="logo-details">
            <img src="../img/icons8-construction-64.png">
            <span class="logo_name">Build Manage</span>
        </div>
        <ul class="nav-links">
            <li>
                <a href="home.html">
                    <i class='bx bx-grid-alt'></i>
                    <span class="links_name">Dashboard</span>
                </a>
            </li>
            <li>
                <a href="addproject.html">
                    <i class='bx bx-box'></i>
                    <span class="links_name">Add Project</span>
                </a>
            </li>
            <li>
                <a href="projectsView.html" class="active">
                    <i class='bx bx-list-ul'></i>
                    <span class="links_name">Project Views</span>
                </a>
            </li>
            <li>
                <a href="#">
                    <i class='bx bx-pie-chart-alt-2'></i>
                    <span class="links_name">Order list</span>
                </a>
            </li>
            <li>
                <a href="stocks.html">
                    <i class='bx bx-coin-stack'></i>
                    <span class="links_name">Stock</span>
                </a>
            </li>
            <li>
                <a href="#">
                    <i class='bx bx-book-alt'></i>
                    <span class="links_name">Total order</span>
                </a>
            </li>
            <li>
                <a href="Teams.html">
                    <i class='bx bx-user'></i>
                    <span class="links_name">Team</span>
                </a>
            </li>
            <li class="log_out">
                <a href="../signin.html">
                    <i class='bx bx-log-out'></i>
                    <span class="links_name">Log out</span>
                </a>
            </li>
        </ul>
    </div>
    <section class="home-section">
        <nav>
            <div class="sidebar-button">
                <i class='bx bx-menu sidebarBtn'></i>
                <span class="dashboard">Projects</span>
            </div>
            <div class="profile-details col-3">
                <i class="m-auto"><img id="user-picture" src="" alt="User Picture"></i>
                <h5 class="m-auto" id="username" value="Username"></h5>
            </div>
        </nav>
        <div style="width: 100%; margin-top: 83px; position: absolute;">
            <div class="content-wrapper">
                <!-- Main content -->
                <section class="content">
                    <div class="card-body p-0" id="tablediv">
                        <table class="table table-striped projects ">
                            <thead>
                                <tr>
                                    <th style="width: 1%">
                                        #
                                    </th>
                                    <th style="width: 20%">
                                        Project Name
                                    </th>
                                    <th style="width: 30%">
                                        Total Phases
                                    </th>
                                    <th>
                                        Project Progress
                                    </th>
                                    <th style="width: 8%" class="text-center">
                                        Status
                                    </th>
                                    <th style="width: 20%">
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="ptable">
                            </tbody>
                        </table>
                    </div>
                    <!-- /.card-body -->

                    <div class="card-body p-0 hidden" id="updation" style="overflow-x: hidden;">
                        <div class="row" id="proj">
                            <div class="col-md-6 ml-4">
                                <div class="card card-primary">
                                    <div class="card-header text-white"
                                        style=" background: -webkit-linear-gradient(right, #5f7504, #134756);">
                                        <h4 class="card-title">General</h4>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-group">
                                            <label for="projectname">Update Project Name</label>
                                            <input type="text" id="projectname" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label for="projectDescription">Update Project Description</label>
                                            <textarea id="projectDescription" class="form-control" rows="4"></textarea>
                                        </div>
                                        <div class="form-group d-flex justify-content-between">
                                            <label for="image">Update Project image: </label>
                                            <input id="image1" name="image" type="file"
                                                class="btn btn-success bg-success">
                                        </div>
                                        <div class="form-group">
                                            <label for="projectmanager">Update Project Manager</label>
                                            <input type="text" id="projectmanager" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label for="projectmanager" id="totalphaselabel">Update Complete Phases</label>
                                            <input type="number" id="comphases" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label for="inputStatus">Update Status</label>
                                            <select id="inputStatus" class="form-control custom-select">
                                                <option selected disabled>Select one</option>
                                                <option>On Hold</option>
                                                <option>Canceled</option>
                                                <option>Success</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-5">
                                <div class="card card-secondary">
                                    <div class="card-header text-white"
                                        style=" background: -webkit-linear-gradient(right, #5f7504, #134756);">
                                        <h4 class="card-title">Update Budget</h4>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-group">
                                            <label for="inputEstimatedBudget">Estimated budget</label>
                                            <input type="number" id="inputEstimatedBudget" class="form-control">
                                        </div>
                                        <div class="form-group" id="phasedata">
                                            <label for="projectphases">Total phases</label>
                                            <br>
                                            <div class="row g-3" id="phases">
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-11 m-5">
                                <a href="projectsView.html" class="btn btn-secondary">Cancel</a>
                                <input type="submit" value="Update Project" class="btn btn-success float-right"
                                    onclick="projectupdate()">
                            </div>
                        </div>

                    </div>
                    <div class="card card-solid hidden" id = "proview">
                        <div class="card-body">
                          <div class="row">
                            <div class="col-12 col-sm-6">
                              <div class="col-12">
                                <div class="product-image"><img src="" alt="Product Image" style="height: 100%; width: 100%;" id = "proimage"></div>
                              </div>
                            </div>
                            <div class="col-12 col-sm-6">
                              <h3 class="my-3" id = "pname"></h3>
                              <p id = "pdescription"></p>
                              <hr>
                              <h4>Available Plots</h4>
                                <p id="availableplots">10</p>
                
                                <h4>Price: </h4>
                                <p>10,000,000</p>
                              <div class="mt-4">
                                <button class="btn btn-primary btn-sm btn-flat" onclick="viewaction()">
                                  <i class="fas fa-shopping-cart"></i>Cancel
                                </div>
                              </div>
                
                            </div>
                          </div>
                        </div>
                        <!-- /.card-body -->
                      </div>
                </section>
            </div>
            <!-- /.card -->
    </section>
    <!-- /.content -->
    </div>
    </div>
    </section>

</body>
<script type="text/javascript" src="jquery-3.6.0.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>

<script>
    var selectedrow;
    var totalupdatedphase = [];
    projectshow();
    function viewaction()
    {
        document.getElementById("tablediv").classList.remove("hidden");
        document.getElementById("proview").classList.add("hidden");
    }
    function projectshow() {
        var table = document.getElementById("ptable");
        var list = document.createElement("ul");
        list.classList.add("list-inline");
        var pid;
        var found = false;
        $.ajax({
            url: 'https://ahel-server.vercel.app/getproject',
            headers: {
                'Content-Type': 'application/json'
            },
            type: 'GET',
            contentType: 'application/json',
            success: function (result) {
                pid = result[0].id;
                for (var i = 0; i < result.length; i++) {
                    if (i + 1 != result.length) {
                        var cond = (result[i].id != result[(i + 1)].id);
                    }
                    else {
                        cond = true;
                    }
                    if (cond || i + 1 == result.length) {
                        var totalprogress = (result[i].completephase/result[i].totalphases)*100;
                        var row = document.createElement("tr");
                        pid = result[i].id;
                        row = assignid(row, pid);
                        var col1 = document.createElement("td");
                        col1.innerText = "#";
                        row.appendChild(col1);
                        var col2 = document.createElement("td");
                        col2.innerText = result[i].pname;
                        row.appendChild(col2);
                        var item = document.createElement("li");
                        item.classList.add("list-inline-item");
                        if (result[i].status == "active") {
                            item.classList.add("btn-success");
                        }
                        else {
                            item.classList.add("btn-secondary");
                        }
                        item.classList.add("p-1");
                        item.classList.add("m-1");
                        item.classList.add("rounded");
                        item.innerHTML = capitalizeFirstLetter(result[i].name);
                        list.appendChild(item);
                        var col3 = document.createElement("td");
                        col3.appendChild(list);
                        row.appendChild(col3);
                        var col4 = document.createElement("td");
                        col4.classList.add("project_progress");
                        var col4div = document.createElement("div");
                        col4div.classList.add("progress");
                        col4div.classList.add("progress-sm");
                        var col4div2 = document.createElement("div");
                        col4div2.classList.add("progress-bar");
                        col4div2.classList.add("bg-green");
                        col4div2.role = "progressbar";
                        col4div2.ariaValueNow= totalprogress;
                        col4div2.ariaValueMax = 100;
                        col4div2.ariaValueMin = 0;
                        col4div2.style.width = totalprogress + "%";
                        col4div.appendChild(col4div2);
                        var col4div3 = document.createElement("small");
                        col4div3.innerHTML = (totalprogress.toPrecision(3)) + "%";
                        
                        col4.appendChild(col4div);
                        col4.appendChild(col4div3);
                        row.appendChild(col4);
                        var col5 = document.createElement("td");
                        col5.classList.add("project-state");
                        var sp = document.createElement("span");
                        sp.classList.add("badge");
                        sp.classList.add("badge-success");
                        sp.innerHTML = result[0].pstatus;
                        col5.appendChild(sp);
                        row.appendChild(col5);
                        var col6 = document.createElement("td");
                        col6.classList.add("project-actions");
                        col6.classList.add("text-right");
                        var btn1 = document.createElement("button");
                        btn1.classList.add("btn");
                        btn1.classList.add("btn-primary");
                        btn1.classList.add("btn-sm");
                        btn1.classList.add("m-1");
                        btn1.addEventListener("click", function () { viewproject(event) });
                        btn1.innerHTML = "View";
                        var btn2 = document.createElement("button");
                        btn2.classList.add("btn");
                        btn2.classList.add("btn-info");
                        btn2.classList.add("btn-sm");
                        btn2.classList.add("m-1");
                        btn2.innerHTML = "Edit";
                        btn2.id = "btn" + row.id;
                        btn2.addEventListener("click", function () { updateproject(event) });
                        var btn3 = document.createElement("button");
                        btn3.classList.add("btn");
                        btn3.classList.add("btn-danger");
                        btn3.classList.add("btn-sm");
                        btn3.classList.add("m-1");
                        btn3.innerHTML = "Delete";
                        col6.id = result[i].id;
                        col6.appendChild(btn1);
                        col6.appendChild(btn2);
                        col6.appendChild(btn3);
                        row.appendChild(col6);
                        table.appendChild(row);
                        list = document.createElement("ul");
                        list.classList.add("list-inline");
                    }
                    else {
                        var item = document.createElement("li");
                        item.classList.add("list-inline-item");
                        if (result[i].status == "active") {
                            item.classList.add("btn-success");
                        }
                        else {
                            item.classList.add("btn-secondary");
                        }
                        item.classList.add("p-1");
                        item.classList.add("m-1");
                        item.classList.add("rounded");
                        item.innerHTML = capitalizeFirstLetter(result[i].name);

                        list.appendChild(item);
                        found = true;
                    }
                }
            },
            error: function () {
                alert('error');
            }
        });
    }
    let sidebar = document.querySelector(".sidebar");
    let sidebarBtn = document.querySelector(".sidebarBtn");
    sidebarBtn.onclick = function () {
        sidebar.classList.toggle("active");
        if (sidebar.classList.contains("active")) {
            sidebarBtn.classList.replace("bx-menu", "bx-menu-alt-right");
        } else
            sidebarBtn.classList.replace("bx-menu-alt-right", "bx-menu");
    }


    //getting user data using session id
    var id = sessionStorage.getItem("id");
    var data = { id: id };
    let post = JSON.stringify(data);
    $.ajax({
        url: 'https://ahel-server.vercel.app/getdata',
        headers: {
            'Content-Type': 'application/json'
        },
        type: 'POST',
        contentType: 'application/json',
        data: post,
        success: function (result) {
            result.forEach(element => {
                var name = element.firstname + " " + element.lastname;
                document.getElementById("username").innerHTML = name;
                $("#user-picture").attr("src", "../uploads/" + element.image);
            });
        },
        error: function () {
            alert('error');
        }
    });

    function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    }
    function updateproject(event) {
        var id = event.target.parentElement.id;
        selectedrow = id;
        var data = { id: id };
        let post = JSON.stringify(data);
        $.ajax({
            url: 'https://ahel-server.vercel.app/getprojectupdate',
            headers: {
                'Content-Type': 'application/json'
            },
            type: 'POST',
            contentType: 'application/json',
            data: post,
            success: function (result) {
                pid = result[0].id;
                for (var i = 0; i < result.length; i++) {
                    if (i + 1 != result.length) {
                        var cond = (result[i].id != result[(i + 1)].id);
                    }
                    else {
                        cond = true;
                    }
                    if (cond || i + 1 == result.length) {
                        document.getElementById("totalphaselabel").innerHTML = "Update Complete Phases ( " + result[i].totalphases + " )";
                        document.getElementById("comphases").value = result[i].completephase;
                        document.getElementById("projectname").value = result[i].pname;
                        document.getElementById("projectDescription").value = result[i].pdescription;
                        document.getElementById("projectmanager").value = result[i].pmanager;
                        document.getElementById("inputStatus").value = result[i].pstatus;
                        document.getElementById("inputEstimatedBudget").value = result[i].budget;
                        document.getElementById("tablediv").classList.add("hidden");
                        document.getElementById("phasedata").classList.remove("hidden");
                        document.getElementById("updation").classList.remove("hidden");

                        var pdiv = document.createElement("div");
                        pdiv.classList.add("form-group");
                        var plabel = document.createElement("label");
                        plabel.innerHTML = "Update Phase status of " + capitalizeFirstLetter(result[i].name) ;
                        var pselect = document.createElement("select");
                        pselect.classList.add("form-control");
                        pselect.classList.add("custom-select");
                        pselect.id = "inputStatus" + result[i].phaseid;
                        totalupdatedphase.push(result[i].phaseid);
                        var option1 = document.createElement("option");
                        option1.innerHTML = result[i].status;
                        option1.selected = true;

                        var option2 = document.createElement("option");
                        option2.innerHTML = "active";

                        var option3 = document.createElement("option");
                        option3.innerHTML = "not active";
                        pdiv.appendChild(plabel);
                        pselect.appendChild(option1);
                        pselect.appendChild(option2);
                        pselect.appendChild(option3);
                        pdiv.appendChild(pselect);
                        document.getElementById("phasedata").appendChild(pdiv);
                    }
                    else {
                        document.getElementById("tablediv").classList.add("hidden");
                        document.getElementById("phasedata").classList.remove("hidden");
                        document.getElementById("updation").classList.remove("hidden");

                        var pdiv = document.createElement("div");
                        pdiv.classList.add("form-group");
                        var plabel = document.createElement("label");
                        plabel.innerHTML = "Update Phase status of " + capitalizeFirstLetter(result[i].name) ;
                        var pselect = document.createElement("select");
                        pselect.classList.add("form-control");
                        pselect.classList.add("custom-select");
                        pselect.id = "inputStatus" + result[i].phaseid;
                        totalupdatedphase.push(result[i].phaseid);
                        var option1 = document.createElement("option");
                        option1.innerHTML = result[i].status;
                        option1.selected = true;

                        var option2 = document.createElement("option");
                        option2.innerHTML = "active";

                        var option3 = document.createElement("option");
                        option3.innerHTML = "not active";
                        pdiv.appendChild(plabel);
                        pselect.appendChild(option1);
                        pselect.appendChild(option2);
                        pselect.appendChild(option3);
                        pdiv.appendChild(pselect);
                        document.getElementById("phasedata").appendChild(pdiv);
                    }
                }
            },
            error: function () {
                alert('error');
            }
        });
    }
    function assignid(row, id) {
        row.id = id;
        return row;
    }

    function projectupdate(){
        var id = selectedrow;
        var pname = $("#projectname").val();
        var pdescription = $("#projectDescription").val();
        var image = $('#image1').prop("files")[0];
        var pmanager = $("#projectmanager").val();
        var pstatus = $("#inputStatus").val();
        var budget = $("#inputEstimatedBudget").val();
        var comphases = $("#comphases").val();
        var phasedata = [];
        totalupdatedphase.forEach(element => {
            phasedata.push($("#inputStatus" + element).val());
        });
        var formData = new FormData();
        formData.append('id', id);
        formData.append('pname', pname);
        formData.append('pdescription', pdescription);
        formData.append('image', image);
        formData.append('pmanager', pmanager);
        formData.append('pstatus', pstatus);
        formData.append('budget', budget);
        formData.append('comphases', comphases);
        formData.append('phasesids', totalupdatedphase);
        formData.append('phasedata',phasedata);
        $.ajax({
            url: 'https://ahel-server.vercel.app/updateproject',
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            success: function (result) {
                alert("Project Updated");
                location.reload();
            },
            error: function () {
                alert('error');
            }
        });
    }

    function viewproject(event)
    {
        document.getElementById("tablediv").classList.add("hidden");
        document.getElementById("proview").classList.remove("hidden");
        var id = event.target.parentElement.id;
        var data = { id: id };
        let post = JSON.stringify(data);
        $.ajax({
            url: 'https://ahel-server.vercel.app/getindividualproject',
            headers: {
                'Content-Type': 'application/json'
            },
            type: 'POST',
            contentType: 'application/json',
            data: post,
            success: function (result) {
                result.forEach(element => {
                $("#proimage").attr("src", "../uploads/" + element.image);
                document.getElementById("pname").innerHTML = element.pname;
                document.getElementById("pdescription").innerHTML = element.pdescription;
                document.getElementById("availableplots").innerHTML = element.plots - element.bookedplots;
            });
            },
            error: function () {
                alert('error');
            }
        });
    }
</script>

</html>